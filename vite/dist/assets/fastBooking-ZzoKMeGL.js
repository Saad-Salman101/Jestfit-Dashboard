import{r as u,v as H,K as ue,b as me,a as he,c as ge,d as $,j as e,F as xe,B as S,g as pe,a7 as C,G as b,i as v,I as F,O as fe,k as N,S as q,M as O,X as z,Y as W,T as p,a8 as je,a9 as De,aa as Ie,L as ye,l as K,ab as Ce,ac as Se,_ as be,$ as ke,a0 as ve,a6 as Be,ad as _e,a1 as we,Z as Le,ae as Te,f as I}from"./index-DLcGPbaO.js";const Ne=()=>{const[g,h]=u.useState([]),[x,f]=u.useState(H()),[B,j]=u.useState([]),[c,y]=u.useState([]),[_,E]=u.useState(!0),w=u.useMemo(()=>Ae(c),[c]),[$e,G]=u.useState([]),[Y,L]=u.useState(!1),[R,X]=u.useState([]),Z=ue(s=>s.user.userDetail),k=me();he();const J=ge({locationID:$().required("Location is required"),fieldID:$().required("Field is required"),customerName:$().required("Customer's name is required")}),[Q,U]=u.useState([]),[M,V]=u.useState([]),[m,T]=u.useState(),ee=async s=>{try{const t=await I.get(`/field?locationID=${s}`);V(t.data.result.results)}catch(t){console.error("Error fetching fields",t)}},te=u.useMemo(()=>c==null?void 0:c.reduce((s,t)=>s+t.price,0),[c]),se=async s=>{const t=x.toDate();t.setHours(0,0,0,0),t.setHours(t.getHours()+5);const a=await I.get("/booking",{params:{date:t,limit:100,fieldID:s.id}});console.log(a.data.result.results,"<==== booking jo hogae"),j(a.data.result.results)},oe=s=>{g.some(t=>t._id===s._id)?h(g.filter(t=>t._id!==s._id)):h([...g,{locationID:m.locationID,fieldID:m.id,name:m.name,date:x.startOf("day").toDate(),...s}])},ae=()=>{let s=[...c];g.forEach(t=>{s.some(r=>r.slotID===t._id&&r.date===t.date)||s.push({...t,vendorID:m.vendorID,slotID:t._id})}),y(s),S.success(`Successfully Added ${g.length} slots to booking`)};u.useEffect(()=>{(async()=>{try{const t=await I.get("/location",{params:{vendorID:Z.vendorID.id,limit:100}});U(t.data.result.results)}catch(t){console.error("Error fetching locations",t)}})()},[]);const ne=async()=>{var r;const s=await I.get(`/field/${m==null?void 0:m.id}`),t=x.toDate();t.setHours(0,0,0,0),t.setHours(t.getHours()+5);const a=await I.get("/booking",{params:{date:t,limit:100,fieldID:s.data.result.id}});j(a.data.result.results),T((r=s==null?void 0:s.data)==null?void 0:r.result)};u.useEffect(()=>{ne()},[_]);let re={locationID:"",fieldID:"",customerName:"",slots:[]};const ie=s=>{const t=c.filter(a=>a._id!==s);y(t),E(!_)},le=async s=>{var a,r,n;const t={cart:c,customerName:s.customerName,type:"fastBooking"};try{const i=await I.post("/order",t);return i.status===201&&(console.log(i.data.result,"<==== saman"),G(i.data.result.order)),console.log(i.data,"<== res"),console.log(i.cart,"<== res"),{isTrue:!0,orderID:i.data.result.order.id}}catch(i){return console.log(i,"<======="),i.response.status===400&&(L(!0),X((n=(r=(a=i==null?void 0:i.response)==null?void 0:a.data)==null?void 0:r.data)==null?void 0:n.conflicts)),{isTrue:!1}}},ce=()=>{const s=new Set(R.map(({bookingData:a})=>`${a.slotID}_${new Date(a.date).toISOString()}`)),t=c.filter(a=>{const r=`${a._id}_${new Date(a.date).toISOString()}`;return!s.has(r)});y(t)},de=async s=>{var t,a,r;try{const n=await I.put("/order/fast",{orderID:s});console.log(n.data),n.status===200&&(S.success("Your Booking has been placed"),y([]),h([]))}catch(n){console.log(n),S.error("Oops something went wrong"),S.error((r=(a=(t=n==null?void 0:n.response)==null?void 0:t.data)==null?void 0:a.data)==null?void 0:r.message)}};return e.jsx(xe,{initialValues:re,validationSchema:J,onSubmit:async(s,{setSubmitting:t})=>{var a,r;t(!0);try{let n=await le(s);console.log(n,"<=================== cart bhek l loruet"),n.isTrue&&await de(n.orderID)}catch(n){console.log(n),S.error((r=(a=n==null?void 0:n.response)==null?void 0:a.data)==null?void 0:r.message)}t(!1)},children:({values:s,handleChange:t,handleBlur:a,handleSubmit:r,isSubmitting:n,touched:i,errors:D,setFieldValue:A})=>{var P;return e.jsxs(pe,{onSubmit:r,children:[e.jsx(C,{sx:{flexGrow:1,p:2},children:e.jsxs(b,{container:!0,spacing:2,children:[e.jsxs(v,{fullWidth:!0,error:!!(i.customerName&&D.customerName),sx:{...k.typography.customInput},children:[e.jsx(F,{htmlFor:"outlined-adornment-name-register",children:"Customer Name"}),e.jsx(fe,{id:"outlined-adornment-name-register",value:s.customerName,name:"customerName",onBlur:a,onChange:t}),i.customerName&&D.customerName&&e.jsx(N,{error:!0,id:"standard-weight-helper-text--register",children:D.customerName})]}),e.jsxs(v,{sx:{...k.typography.customSelect},fullWidth:!0,children:[e.jsx(F,{id:"LocationID",children:"Location"}),e.jsx(q,{label:"Location",labelId:"LocationID",id:"locationID",value:s.locationID,onChange:o=>{j([]),T({}),A("locationID",o.target.value),A("field",""),ee(o.target.value)},children:Q.map((o,d)=>e.jsx(O,{value:o.id,children:o.name},d))}),i.locationID&&D.locationID&&e.jsx(N,{error:!0,id:"locationID",children:D.locationID})]}),e.jsxs(v,{fullWidth:!0,sx:{...k.typography.customSelect},children:[e.jsx(F,{id:"fieldID",children:"Field"}),e.jsxs(q,{label:"Field",labelId:"fieldID",id:"fieldID",value:s.fieldID,onChange:o=>{A("fieldID",o.target.value);let d=M.find(l=>l.id===o.target.value);console.log(d,"<=== field"),T(d),se(d)},children:[e.jsx(O,{value:"",children:e.jsx("em",{children:"None"})}),M.map((o,d)=>e.jsx(O,{value:o.id,children:o.name},d))]}),i.fieldID&&D.fieldID&&e.jsx(N,{error:!0,id:"sportTypeID",children:D.fieldID})]}),e.jsx(b,{width:"100%",item:!0,xs:12,children:e.jsx(z,{children:e.jsxs(W,{children:[e.jsx(p,{textTransform:"capitalize",variant:"h1",component:"h2",gutterBottom:!0,textAlign:"center",onClick:()=>{console.log(c,"<====")},children:m==null?void 0:m.name}),e.jsx(je,{dateAdapter:De,children:e.jsx(Ie,{minDate:H(),label:"Select Booking Date",value:x,onChange:o=>{y([]),h([]),f(o),E(!_)},renderInput:o=>e.jsx(ye,{...o,fullWidth:!0})})}),e.jsx(p,{onClick:()=>console.log(c,"<=== cart wow"),variant:"h3",mt:4,mb:4,component:"h3",gutterBottom:!0,children:"Available Slots:"}),e.jsx(b,{container:!0,spacing:2,children:(P=m==null?void 0:m.slots)==null?void 0:P.map(o=>{const d=B.some(l=>l.slotID===o._id);return e.jsx(b,{item:!0,xs:12,sm:6,md:3,children:e.jsxs(C,{sx:{padding:2,border:"1px solid",borderColor:g.some(l=>l._id===o._id)?"secondary.dark":"grey.300",borderRadius:2,cursor:d?"not-allowed":"pointer",backgroundColor:g.some(l=>l._id===o._id)||c.some(l=>l._id===o._id&&l.date===o.date)?"secondary.light":"white",transition:"background-color 0.3s",textAlign:"center",opacity:d?.5:1},onClick:()=>!d&&oe(o),children:[e.jsxs(p,{variant:"body1",component:"p",children:[o.to," - ",o.from]}),e.jsxs(p,{variant:"body2",component:"p",children:["Price: $",o.price]})]})},o._id)})}),e.jsx(C,{mt:3,gap:5,display:"flex",justifyContent:"center",children:e.jsxs(K,{variant:"contained",color:"secondary",size:"large",disabled:g.length===0||!x,onClick:ae,children:["Add To Booking ",e.jsx(Ce,{style:{marginLeft:"8px"}})]})})]})})}),e.jsxs(v,{fullWidth:!0,sx:{justifyContent:"center",alignItems:"center",width:"100%"},children:[e.jsx(p,{variant:"h3",sx:{...k.typography.customInput},children:"Slots"}),c.length===0?e.jsx(C,{sx:{textAlign:"center"},maxWidth:"100%",children:e.jsx(Se,{size:"small"})}):e.jsxs(e.Fragment,{children:[Object.keys(w).map(o=>e.jsx(z,{sx:{marginBottom:2},children:e.jsxs(W,{children:[e.jsx(p,{variant:"h4",sx:{marginBottom:1},textTransform:"capitalize",children:o}),Object.keys(w[o]).map(d=>e.jsxs(C,{sx:{marginLeft:2,marginBottom:2},children:[e.jsx(p,{variant:"subtitle1",sx:{color:"text.secondary"},children:d}),e.jsx(be,{children:w[o][d].slots.map(l=>e.jsxs(ke.Fragment,{children:[e.jsx(ve,{secondaryAction:e.jsx(Be,{edge:"end","aria-label":"delete",onClick:()=>ie(l._id),children:e.jsx(_e,{})}),children:e.jsx(we,{primary:`${l.to} -  ${l.from} `,secondary:`Price: ${l.price} PKR`})}),e.jsx(Le,{})]},l._id))})]},d))]})},o)),e.jsx(C,{sx:{marginTop:4},children:e.jsxs(p,{variant:"h6",textAlign:"center",children:["Total Amount: $",te," PKR"]})})]})]}),e.jsx(b,{textAlign:"center",item:!0,xs:12,children:e.jsx(K,{disabled:c.length===0,type:"submit",size:"large",variant:"contained",color:"secondary",children:"Create Booking"})})]})}),e.jsx(Te,{open:Y,conflicts:R,handleClose:L,handleRemoveSlot:()=>{y([]),h([]),L(!1)},handleContinueToPayment:ce})]})}})},Ae=g=>g.reduce((h,x)=>{const{name:f,date:B}=x,j=new Date(B).toLocaleDateString();return h[f]||(h[f]={}),h[f][j]||(h[f][j]={slots:[]}),h[f][j].slots.push(x),h},{});export{Ne as default};
